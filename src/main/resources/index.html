<!DOCTYPE html>
<html>
<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #container {
            font-family: 'Comic sans MS';
        }

        #add-receipt {
          background-color:#A6A8AB;
          width: 60px;
          margin-top: 25px;
          float: right;
          font-size: 2em;
          color: white;
          text-align: center;
          cursor: pointer;
        }

        #add-receipt:hover {
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #receiptList {
            border: 1px solid green;
            clear: both;
            display: table-row-group;
            text-align: left;
            border-collapse: collapse;
        }

        .time, .merchant, .amount, .tags {
            border: 1px solid #999999;
        }

        #add-receipt-popup {
            background-color: white;
            width: 200px;
            height: 100px;
            position: absolute;
            top: 75px;
            right: 7px;
            border: 1px solid #E6E7E8;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            padding: 15px
        }

        #save-receipt {
            background-color: #58595B;
            color:white;
            displayï¼šinline-block;
            width: 60px;
            text-align: center;
            float: right;
            cursor: pointer;
        }

        #cancel-receipt {
            background-color: #58595B;
            color: white;
            margin-left: 15px;
            text-align: center;
            width: 60px;
            float: right;
            margin-right:18px;
            cursor: pointer;
        }

        input[type=text] {
          border-left: none;
          border-right: none;
          border-top: none;
          border-bottom: 1px solid #58595B;
        }

        .receipt {
            background-color: #E6E7E8;
            display: table-row;
        }

        .tableHeader {
            display: table-row;
            font-weight: bold;
        }

        .table {
            display: table;
            width: 100%;
        }

        .tableCell, .time, .merchant, .amount, .tags {
            display: table-cell;
        }

        .add-tag {
            width: 100px;
            background-color: #0067C5;
            color: white;
            display: inline-block;
            text-align: center;
            cursor: pointer;
        }

        .tagValue {
            background-color: #F4A71C;
            color: white;
            display: inline-block;
            text-align: center;
            cursor: pointer;
        }

    </style>
    <script>
        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        $(function(){
            const api = ""; // <- do not need a root api URL if this page is served directly by the API

            var toggleTag = function(receiptID, tag, success) {
              $.ajax({
                  type: 'PUT',
                  contentType: 'application/json',
                  dataType: 'json',
                  url: api+"/tags/" + tag,
                  data: JSON.stringify(receiptID),
                  success: success
              });
            };

            $.getJSON(api+"/receipts", function(receipts){
                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    $(`<div class="receipt">
                            <div class="time">${receipt.created}</div>
                            <div class="merchant">${receipt.merchantName}</div>
                            <div class="amount">${receipt.value}</div>
                            <div class="tags" id=${receipt.id}><div class="add-tag">Add +</div></div>
                        </div>`).appendTo($("#receiptList"));
                    for (var j=0; j<receipt.tags.length; j++) {
                        var tag = receipt.tags[j];
                        $(`<div class='tag'><p class="tagValue">${tag}</p></div>`).appendTo($('#' + receipt.id));
                    }
                }
            });

            $(document).on('click', '#save-receipt', function() {
                var merchant = $("#merchant").val();
                var amount = $("#amount").val();
                var data = {"merchant": merchant, "amount": amount};
                var time = new Date();
                $.ajax({
                    type: 'POST',
                    contentType: 'application/json',
                    dataType: 'json',
                    url: api+"/receipts",
                    data: JSON.stringify(data),
                    success: function(response) {
                      $(`<div class="receipt">
                              <div class="time">${time}</div>
                              <div class="merchant">${merchant}</div>
                              <div class="amount">${amount}</div>
                              <div class="tags" id=${response}><div class="add-tag">Add +</div></div>
                          </div>`).appendTo($("#receiptList"));
                        $('#add-receipt-popup').toggle();
                    }
                });
            });

            $(document).on('click', '#add-receipt', function() {
                $('#add-receipt-popup').toggle();
            });


            $(document).on('click', '#cancel-receipt', function() {
                $('#add-receipt-popup').toggle();
            });

            $(document).on('click', '.add-tag', function() {
                if ($('tag_input').length == 0) {
                    $(`<input class='tag_input' type='text'>`).appendTo($(this).parent());
                } else {
                    $('tag_input').remove();
                }
            });

            $(document).on('click', '.tag', function() {
                $(this).remove();
            });

            $(document).on('keypress', '.tag_input', function(e) {
                if (e.which === 13) {
                    var id = $(this).parent().attr('id');
                    var tag = $(this).val();
                    $(`<div class='tag'><p class="tagValue">${tag}</p></div>`).appendTo($('#' + id));
                    $(this).remove();
                }
            })
        })
    </script>
</head>

<body>
  <div id="container">
    <div>
      <h1 style = 'float:left'>My receipts</h1>
      <div id="add-receipt">+</div>
      <div id="add-receipt-popup" style='display:none'>
        <form>
          <input type="text" id="merchant" placeholder="Merchant"><br>
          <input type="text" id="amount" placeholder="Amount"><br>
        </form>
        <div style="margin-top:20px">
          <div id="cancel-receipt">Cancel</div>
          <div id="save-receipt">Save</div>
        </div>
      </div>
    </div>
    <div class="table">
      <div class="tableHeader">
        <div class="tableCell">Time</div>
        <div class="tableCell">Merchant</div>
        <div class="tableCell">$</div>
        <div class="tableCell">Tags</div>
      </div>
      <div id="receiptList">
      </div>
    </div>
  </div>
</body>

</html>
